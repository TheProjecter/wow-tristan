<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title></title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<link href="gadget.css" rel="stylesheet" type="text/css" />
	</head>

	<script language="VBScript">
		Sub Window_Onload
			Dim tickerTimer, iconTimer, onlineTimer
			
			GetTicker
			tickerTimer = window.SetInterval("GetTicker", 60000)
			
			GetIcons
			iconTimer = window.SetInterval("GetIcons", 60000)
			
			GetOnline
			onlineTimer = window.SetInterval("GetOnline", 60000)
		End Sub
		
		Sub GetOnline
			onlineArea.InnerHTML = "1337 online"
		End Sub
		
		Sub GetIcons
			
			Dim sUsername
			sUsername = "Webmaster"
			If System.Gadget.Settings.readString("Username") <> vbNullString Then
				sUsername = System.Gadget.Settings.readString("Username")
			End If
			
			gbIcon.alt = sUsername & " har 0 nya gästboks-inlägg."
			gbLink.href = "http://www.lunarstorm.se/" & sUsername
			
			'If System.Gadget.Settings.readString("UpdateInfo") = "!" Then
				'Update userinfo for correct casing of Username etc
				
				'Once updated clear the update flag
				'System.Gadget.Settings.writeString("UpdateInfo", vbNullString)
			'End If
			
			'gbIcon.src = "_gfx/icon/icon-guestbook-active.gif"
			'gbIcon.alt = sUsername & " har 555 nya gästboks-inlägg!"
			'lmIcon.src = "_gfx/icon/icon-lunarmail-active.gif"
			'fmIcon.src = "_gfx/icon/icon-forum-active.gif"
			'frIcon.src = "_gfx/icon/icon-friends-active.gif"
			'cmIcon.src = "_gfx/icon/icon-comment-active.gif"
		End Sub

		Sub GetTicker
			Dim xmlHttp, xmlData, xmlParser
			Dim xmlNodes, xmlNode, xmlError
			Dim sText, sLink, sDate, sUser
			Dim bSuccess, sResult, sSpace

			sSpace = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"

			Set xmlParser = CreateObject("MSXML2.DOMDocument.6.0")
			xmlParser.Async = False
			bSuccess = xmlParser.Load("http://api.lunarstorm.se/api.ashx?type=rss&function=Live")

			If bSuccess Then
				Set xmlError = xmlParser.SelectSingleNode("error/item/description")
				
				If Not xmlError Is Nothing then
					sResult = "Error: " & xmlError.Text & " (will keep trying)"
				Else
					Set xmlNodes = xmlParser.SelectNodes("/rss/channel/item")
					sResult = sSpace
					
					For Each xmlNode In xmlNodes
						sText = xmlNode.SelectSingleNode("description").Text
						sLink = xmlNode.SelectSingleNode("link").Text
						sDate = xmlNode.SelectSingleNode("pubDate").Text
						sUser = xmlNode.SelectSingleNode("title").Text
						
				 		sResult = sResult & "<a href=""" & sLink & """ class=""tickerLink"">" & sUser & ": " & sText & "</a>" & sSpace
					Next
				End If
				
				Set xmlError = Nothing
				Set xmlNode = Nothing
				Set xmlNodes = Nothing
			End If

			Set xmlParser = Nothing
			Set xmlHttp = Nothing

			theTicker.InnerHTML = sResult
		End Sub
	</script>

	<script type="text/javascript" language="javascript">
		function initGadget()
		{
			System.Gadget.settingsUI = "settings.htm";
			
			checkState();
			System.Gadget.onDock = checkState;
			System.Gadget.onUndock = checkState;
		}

		function checkState()
		{
			if(!System.Gadget.docked)
			{
				undockedState();
			}
			else if (System.Gadget.docked)
			{
				dockedState();
			}
		}

		function undockedState()
		{
			//-- Resize body
			document.body.style.width = 730;
			System.Gadget.background = "_gfx/bg_large.png";
			
			//-- Resize elements
			document.getElementById("tickerArea").style.width = 730;
			document.getElementById("iconArea").style.top = 3;
			document.getElementById("iconArea").style.width = 166;
			document.getElementById("iconArea").style.height = 28;
			document.getElementById("gbIcon").style.width = 28;
			document.getElementById("lmIcon").style.width = 28;
			document.getElementById("fmIcon").style.width = 28;
			document.getElementById("frIcon").style.width = 28;
			document.getElementById("cmIcon").style.width = 28;
			
			//-- Show extra stuff
			document.getElementById("extrasArea").style.visibility = "visible";
		}

		function dockedState()
		{
			//-- Resize body
			document.body.style.width=130;
			System.Gadget.background = "_gfx/bg_small.png";
			
			//-- Resize elements
			document.getElementById("tickerArea").style.width = 130;
			document.getElementById("iconArea").style.top = 8;
			document.getElementById("iconArea").style.width = 130;
			document.getElementById("iconArea").style.height = 22;
			document.getElementById("gbIcon").style.width = 22;
			document.getElementById("lmIcon").style.width = 22;
			document.getElementById("fmIcon").style.width = 22;
			document.getElementById("frIcon").style.width = 22;
			document.getElementById("cmIcon").style.width = 22;
			
			//-- Hide extra stuff
			document.getElementById("extrasArea").style.visibility = "hidden";
		}
		
		function resetSearch()
		{
			document.getElementById("searchBox").value = 'Sök...';
		}
		function clearSearch()
		{
			document.getElementById("searchBox").value = '';
		}
	</script>

	<body onload="initGadget()">
		<div id="iconArea" class="iconArea">
			<a id="gbLink" href="javascript:void(0);"><img src="_gfx/icon/icon-guestbook.gif" id="gbIcon" class="topIcon" alt="" /></a>
			<a id="lmLink" href="javascript:void(0);"><img src="_gfx/icon/icon-lunarmail.gif" id="lmIcon" class="topIcon" alt="" /></a>
			<a id="fmLink" href="javascript:void(0);"><img src="_gfx/icon/icon-forum.gif" id="fmIcon" class="topIcon" alt="" /></a>
			<a id="frLink" href="javascript:void(0);"><img src="_gfx/icon/icon-friends.gif" id="frIcon" class="topIcon" alt="" /></a>
			<a id="cmLink" href="javascript:void(0);"><img src="_gfx/icon/icon-comment.gif" id="cmIcon" class="topIcon" alt="" /></a>
		</div>
		
		<div id="extrasArea" class="extrasArea"  style="visibility:hidden;">
			<div id="onlineArea" class="onlineArea">Updating...</div>
			<div id="searchArea" class="searchArea">
				<form method="get" action="http://www.lunarstorm.se/src/src_quicksearch.aspx">
					<div id="searchBoxBorder"></div><div id="searchBoxHolder"></div><input type="text" id="searchBox" name="all" value="Sök..." onfocus="clearSearch()" onblur="resetSearch()"/>
				</form>
			</div>
			<div id="logoArea" class="logoArea"><a href="http://www.lunarstorm.se/"><img src="_gfx/logo.png" style="vertical-align: middle;" border=0></a></div>
		</div>
		
		<div id="tickerArea" class="tickerArea">
			<marquee scrollamount="4" width="100%" id="theTicker" class="ticker" onMouseOver="theTicker.stop()" onMouseOut="theTicker.start()">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</marquee>
		</div>
    
		<div id="Debug" class="Debug" style="visibility:hidden;" />
	</body>
</html>